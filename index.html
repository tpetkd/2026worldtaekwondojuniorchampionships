/**
 * 跆拳道國際賽報名系統 - Google Apps Script 後端
 * 
 * ========== 設定步驟 ==========
 * 
 * 1. 開啟 Google Drive，新建一個 Google Sheet
 * 2. 在 Sheet 中，點選「擴充功能」→「Apps Script」
 * 3. 刪除預設程式碼，貼上這整份程式碼
 * 4. 修改下方的 SPREADSHEET_ID 和 FOLDER_ID
 * 5. 點選「部署」→「新增部署作業」
 * 6. 選擇類型「網頁應用程式」
 * 7. 執行身分選「我」
 * 8. 存取權限選「所有人」
 * 9. 點選「部署」，複製產生的 URL
 * 10. 將該 URL 貼到 HTML 檔案的 GOOGLE_SCRIPT_URL 變數
 * 
 * ========== 設定區域 ==========
 */

// 你的 Google Sheet ID（從網址複製）
// 例如：https://docs.google.com/spreadsheets/d/ABC123xyz/edit
// 則 ID 為 ABC123xyz
const SPREADSHEET_ID = '1eOgXq5SnQ5SpKyTqzEUaSA-2w1VHLaLZG9mn89rYX7M';

// Google Drive 資料夾 ID（用來存放上傳的檔案）
const FOLDER_ID = '1Jubu760AqvdGVdC3kr-mjZA7MO1ORdG7';

// Sheet 名稱
const SHEET_NAME = '報名資料';

/**
 * ========== 主要函數 ==========
 */

// 處理 POST 請求
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    // 處理檔案上傳
    const fileFields = [
      'passport_file',
      'photo_file', 
      'dan_certificate',
      'domestic_coach_cert',
      'intl_coach_cert',
      'bankbook_file'
    ];
    
    const fileUrls = {};
    const folder = DriveApp.getFolderById(FOLDER_ID);
    
    // 建立以姓名+時間命名的子資料夾
    const applicantName = data.name_zh || 'Unknown';
    const timestamp = new Date().toISOString().slice(0, 10);
    const subFolderName = `${applicantName}_${timestamp}_${Date.now()}`;
    const subFolder = folder.createFolder(subFolderName);
    
    // 處理每個檔案欄位
    for (const field of fileFields) {
      if (data[field] && data[field] !== '') {
        try {
          const fileData = JSON.parse(data[field]);
          if (fileData.data && fileData.name) {
            const blob = Utilities.newBlob(
              Utilities.base64Decode(fileData.data),
              fileData.type,
              fileData.name
            );
            const file = subFolder.createFile(blob);
            fileUrls[field] = file.getUrl();
          }
        } catch (fileError) {
          fileUrls[field] = 'Error: ' + fileError.message;
        }
      }
    }
    
    // 準備寫入 Sheet 的資料
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    
    // 如果 Sheet 是空的，先建立標題列
    if (sheet.getLastRow() === 0) {
      const headers = [
        '提交時間',
        '中文姓名',
        '英文姓',
        '英文名',
        '性別',
        '出生日期',
        '身份證字號',
        '護照號碼',
        'Email',
        '戶籍地址',
        '現居住地址',
        '聯絡方式',
        '護照發照日',
        '護照效期日',
        '原住民身份',
        '護照檔案連結',
        '大頭照連結',
        '職稱',
        '世盟會員證號',
        '比賽項目',
        '量級/組別',
        '選拔成績',
        '國際段證連結',
        '國內教練證連結',
        '國際教練證連結',
        '監護人姓名',
        '與選手關係',
        '監護人身分證字號',
        '監護人出生日期',
        '監護人手機',
        '監護人地址',
        '飲食習慣',
        '其他飲食需求',
        '其他注意事項',
        '銀行名稱',
        '帳戶名稱',
        '銀行帳號',
        '存摺影本連結',
        '資料夾連結'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
      sheet.getRange(1, 1, 1, headers.length).setBackground('#0abab5');
      sheet.getRange(1, 1, 1, headers.length).setFontColor('#ffffff');
    }
    
    // 轉換顯示值
    const genderMap = { male: '男', female: '女' };
    const roleMap = { athlete: '選手', coach: '教練', athletic_trainer: '防護員/物理治療師', other: '其他' };
    const relationMap = { father: '父親', mother: '母親', grandparent: '祖父母', legal_guardian: '法定監護人', other: '其他' };
    const dietMap = { normal: '都可', lacto_ovo: '奶蛋素', vegan: '純素', no_beef: '不吃牛', no_shellfish: '不吃甲殼類', other: '其他' };
    const rankMap = { '1': '第1名', '2': '第2名'};
    
    // 準備資料列
    const rowData = [
      new Date().toLocaleString('zh-TW'),
      data.name_zh || '',
      data.last_name_en || '',
      data.first_name_en || '',
      genderMap[data.gender] || data.gender || '',
      data.birthdate || '',
      data.id_number || '',
      data.passport_number || '',
      data.email || '',
      data.registered_address || '',
      data.current_address || '',
      data.contact || '',
      data.passport_issue_date || '',
      data.passport_expiry_date || '',
      data.indigenous || '',
      fileUrls.passport_file || '',
      fileUrls.photo_file || '',
      roleMap[data.role] || data.role || '',
      data.wt_member_id || '',
      compTypeMap[data.competition_type] || data.competition_type || '',
      data.weight_category || '',
      rankMap[data.selection_rank] || data.selection_rank || '',
      fileUrls.dan_certificate || '',
      fileUrls.domestic_coach_cert || '',
      fileUrls.intl_coach_cert || '',
      data.guardian_name || '',
      relationMap[data.guardian_relationship] || data.guardian_relationship || '',
      data.guardian_id || '',
      data.guardian_birthdate || '',
      data.guardian_phone || '',
      data.guardian_address || '',
      dietMap[data.diet] || data.diet || '',
      data.diet_other_detail || '',
      data.other_notes || '',
      data.bank_name || '',
      data.account_name || '',
      data.account_number || '',
      fileUrls.bankbook_file || '',
      subFolder.getUrl()
    ];
    
    // 寫入資料
    sheet.appendRow(rowData);
    
    // 發送確認 Email（可選）
    if (data.email) {
      try {
        sendConfirmationEmail(data);
      } catch (emailError) {
        console.log('Email sending failed:', emailError);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: '報名資料已成功提交',
      folderUrl: subFolder.getUrl()
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// 處理 GET 請求（測試用）
function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'ok',
    message: '跆拳道報名系統後端運作中',
    timestamp: new Date().toISOString()
  })).setMimeType(ContentService.MimeType.JSON);
}

/**
 * 發送確認 Email
 */
function sendConfirmationEmail(data) {
  const subject = '【2026世界青年跆拳道錦標賽】報名資料已收到';
  const body = `
親愛的 ${data.name_zh} 您好，

感謝您的填寫！

我們已收到您的報名資料，以下是您填寫的基本資訊：

姓名：${data.name_zh}
英文姓名：${data.first_name_en} ${data.last_name_en}
護照號碼：${data.passport_number}
戶籍地址：${data.registered_address}
量級/組別：${data.weight_category || '(非選手免填)'}

如有任何問題，可以透過此 Email 與我聯繫。

祝您一切順利！

吳思嫻
中華民國跆拳道協會 國際組
  `;
  
  MailApp.sendEmail(data.email, subject, body);
}

/**
 * 初始化設定（第一次使用時執行一次）
 */
function initializeSetup() {
  // 建立或取得 Sheet
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
  }
  
  // 建立標題列
  const headers = [
    '提交時間',
    '中文姓名',
    '英文姓',
    '英文名',
    '性別',
    '出生日期',
    '身份證字號',
    '護照號碼',
    'Email',
    '戶籍地址',
    '現居住地址',
    '聯絡方式',
    '護照發照日',
    '護照效期日',
    '原住民身份',
    '護照檔案連結',
    '大頭照連結',
    '職稱',
    '世盟會員證號',
    '量級/組別',
    '選拔成績',
    '國際段證連結',
    '國內教練證連結',
    '國際教練證連結',
    '監護人姓名',
    '與選手關係',
    '監護人身分證字號',
    '監護人出生日期',
    '監護人手機',
    '監護人地址',
    '飲食習慣',
    '其他飲食需求',
    '其他注意事項',
    '銀行名稱',
    '帳戶名稱',
    '銀行帳號',
    '存摺影本連結',
    '資料夾連結'
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
  sheet.getRange(1, 1, 1, headers.length).setBackground('#0abab5');
  sheet.getRange(1, 1, 1, headers.length).setFontColor('#ffffff');
  
  // 凍結標題列
  sheet.setFrozenRows(1);
  
  // 調整欄寬
  sheet.setColumnWidths(1, headers.length, 120);
  
  console.log('設定完成！Sheet 名稱：' + SHEET_NAME);
}

/**
 * 檢查 Email 是否重複（可用於前端驗證）
 */
function checkDuplicateEmail(email) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  
  // Email 在第 9 欄（index 8）
  for (let i = 1; i < data.length; i++) {
    if (data[i][8] === email) {
      return { duplicate: true, message: '此 Email 已被使用' };
    }
  }
  
  return { duplicate: false };
}
